name: Release

on:
  push:
    tags: ["v*"]

jobs:
  release:
    name: cargo release
    environment: build release
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $raw="${{ github.ref_name }}"
          $v=$raw.TrimStart("v")
          echo "version=$v" >> $env:GITHUB_OUTPUT

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Set Cargo.toml version
        run: cargo set-version ${{ steps.version.outputs.version }}
        working-directory: src-tauri

      - name: Set package.json version
        run: pnpm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - uses: dtolnay/rust-toolchain@nightly

      - uses: Swatinem/rust-cache@v2

      - run: pnpm install

      - name: Build Tauri app
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Create portable zip
        shell: pwsh
        working-directory: ./src-tauri/target/release/
        run: |
          $zip="Overseer_${{ github.ref_name }}_x64_en-US.zip"
          7z a -tzip -mm=Deflate $zip Overseer.exe

      - name: Generate SHA256 checksum
        shell: pwsh
        working-directory: ./src-tauri/target/release/
        run: |
          certutil -hashfile Overseer.exe SHA256 > Overseer_${{ github.ref_name }}_SHA256.txt

      - uses: ncipollo/release-action@v1
        with:
          artifacts: |
            ./src-tauri/target/release/*.zip
            ./src-tauri/target/release/*SHA256.txt
            ./src-tauri/target/release/bundle/nsis/*
          prerelease: false
          body: |
            Windows-x64 installer and portable version.
            The portable version requires a WebView2 runtime.

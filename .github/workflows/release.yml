name: Release

on:
  push:
    tags: [ "v*" ]

jobs:
  release:
    name: cargo release
    environment: build release
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $raw="${{ github.ref_name }}"
          $v=$raw.TrimStart("v")
          echo "version=$v" >> $env:GITHUB_OUTPUT

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Set Cargo.toml version
        run: cargo set-version ${{ steps.version.outputs.version }}
        working-directory: src-tauri

      - name: Set package.json version
        run: pnpm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - uses: dtolnay/rust-toolchain@nightly

      - uses: Swatinem/rust-cache@v2

      - run: pnpm install

      - name: Build Tauri app
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Create portable zip
        shell: pwsh
        working-directory: ./src-tauri/target/release/
        run: |
          $zip="Overseer_${{ github.ref_name }}_x64_en-US.zip"
          7z a -tzip -mm=Deflate $zip Overseer.exe

      - name: Generate SHA256 checksum
        shell: pwsh
        working-directory: ./src-tauri/target/release/
        run: |
          certutil -hashfile Overseer.exe SHA256 > Overseer_${{ github.ref_name }}_SHA256.txt

      - uses: ncipollo/release-action@v1
        with:
          artifacts: |
            ./src-tauri/target/release/*.zip
            ./src-tauri/target/release/*SHA256.txt
            ./src-tauri/target/release/bundle/nsis/*
          prerelease: false
          body: |
            Windows-x64 installer and portable version.
            The portable version requires a WebView2 runtime.
      - name: Prepare updater JSON
        id: updater
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $date = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss+00:00")
          $assetUrl = "https://github.com/${{ github.repository }}/releases/download/v$ver/Overseer_${ver}_x64-setup.exe"

          $sigPath = "./src-tauri/target/release/bundle/nsis/Overseer_${ver}_x64-setup.exe.sig"
          $signature = Get-Content $sigPath -Raw

          $json = @{
            version = $ver
            pub_date = $date
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature
                url = $assetUrl
              }
            }
          } | ConvertTo-Json -Depth 10

          Set-Content -Path updater.json -Value $json

      - name: Update Gist
        uses: andymckay/gh-gist@v1
        with:
          gist_id: ${{ secrets.GIST_ID }}
          token: ${{ secrets.GIST_TOKEN }}
          filename: "overseer-updater.json"
          content: |
            ${{
              steps.updater.outputs.content ||
              join('', (Get-Content updater.json -Raw))
            }}